# How to get OpenAPI scheme JSON files?

## get original OpenAPI files from istio/api

We got the original OpenAPI scheme JSON files from [istio/api](https://github.com/istio/api). Don't forget to switch to related tag to generate correct version of Istio.

Then pick the OpenAPI JSON files according to the `apis/` in [istio/client-go](https://pkg.go.dev/istio.io/client-go/pkg/apis) (also, use the right version of Istio).

Currently the OpenAPI schemas here are all hand-picked. Take Istio v1.14 as example, here is the target list:

```
.
├── extensions
│   └── v1alpha1
│       └── wasm_plugin.gen.json
├── networking
│   ├── v1alpha3
│   │   ├── destination_rule.gen.json
│   │   ├── envoy_filter.gen.json
│   │   ├── gateway.gen.json
│   │   ├── service_entry.gen.json
│   │   ├── sidecar.gen.json
│   │   ├── virtual_service.gen.json
│   │   ├── workload_entry.gen.json
│   │   └── workload_group.gen.json
│   └── v1beta1
│       ├── destination_rule.gen.json
│       ├── gateway.gen.json
│       ├── proxy_config.gen.json
│       ├── service_entry.gen.json
│       ├── sidecar.gen.json
│       ├── virtual_service.gen.json
│       ├── workload_entry.gen.json
│       └── workload_group.gen.json
├── security
│   └── v1beta1
│       ├── authorization_policy.gen.json
│       ├── peer_authentication.gen.json
│       └── request_authentication.gen.json
├── telemetry
│   └── v1alpha1
└── type
    └── v1beta1
        └── workload_selector.gen.json
```

Specially for `wasm.gen.json`, it is rename to `wasm_plugin.gen.json`.

## add "paths" field for OpenAPI JSON files

We use (openapi-generator)[https://openapi-generator.tech/] to generate raw rust codes from OpenAPI JSON files. Since `openapi-generator` needs `paths` field, we need to add it manually like:

```
{
  "openapi": "3.0.0",
  "paths": {},  // ADD HERE
  "info": {
    "title": "Describes the structure of messages generated by Istio analyzers.",
    "version": "v1alpha1"
  }
  // ...
}
```

## generate rust code by openapi-generator

Use:

```shell
openapi-generator-cli generate \ 
    -a BlankZhu \   # change author if you like
    -g rust -o ./outout/ -i ./SPEC_FILE.json \  # SPEC_FILE.json is the OpenAPI JSONs we mentioned above.
    --additional-properties=packageName=SPEC_FILE
```

## adapt rust code to kube-rs

To use the CRDs of Istio in kube-rs, we need to add some traits.

Add `use`s at the beginning:

```rust
use kube::CustomResource;
use schemars::JsonSchema;
use serde::{Deserialize, Serialize};
```

Then add `JsonSchema` and `CustomResource`:

```rust
#[derive(CustomResource, Clone, Debug, PartialEq, Default, Serialize, Deserialize, JsonSchema)]
```

That's all! The main idea is clear, and we just need a little more steps to make the rust code production-ready. Check the python codes if you wanna dive into it!